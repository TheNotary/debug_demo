<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>title</title>

<style>

@font-face {
    font-family: "My Custom Font";
    src: url(assets/fonts/SuperMario256.ttf) format("truetype");
}

.Aligner {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.Aligner-item {
  max-width: 50%;
}

.debug {
  display: none;
}

body {
  background-color: grey;
}

#canvas {
  background-color: #ccc;
}

#page-wrap {
  width: 500px;
  margin: 0 auto;
}

#console {
  align-self: flex-start;
  /* min-width: 178px; */
}

#stats {
  align-self: flex-end;
  /* min-width: 178px; */
}

#about-text {
  display: none;
  min-width: 500px;
  font-family: "My Custom Font", Verdana, Tahoma;
}

#overlay-message {
  position: absolute;
  font-family: "My Custom Font", Verdana, Tahoma;
  font-size: 30px;
  color: white;
  width: 180px;
  height: 100px;
  top: 50%;
  left: 50%;
  margin-left: -60px;
  margin-top: -60px;
  text-align: center;
}

#game {
  position: relative;
  display: block;
  max-width: 1000px;
}

#challenge {
  color: white;
  font-size: 28px;
  position: absolute;
  right: 110px;
  top: 88px;
  margin-left: auto;
  margin-right: auto;
  width: 20px;
}

</style>

<script>
// challenge sets
var home_row = [ 'a', 's', 'd', 'f', 'j', 'k', 'l', ';' ]
var home_row_adv = [ 'g', 'h' ]

// Variables
var nCoins = 10;
var available_letters = home_row.concat(home_row_adv);
var currentLetter
var challengeDelay = 20

var gameStatus = 'stopped'
var global_v


var config = {
  "challengeElementId": "challenge",
  "missesElementId": "misses",
  "hitsElementId": "hits"
};

function keyboard_func(e) {
  var keyCode = e.keyCode

  // fix safaris/ chrome macbook pro semicolon keyCode error
  if (keyCode == 186)
    keyCode = 59

  if (gameStatus == 'started' && keyCode >= 32 && keyCode <= 126) {
    var typedLetter = String.fromCharCode(keyCode).toLowerCase()

    if (typedLetter == currentLetter) {
      register_a_hit(currentLetter, keyCode)
      clear_challenge()
      if (gameStatus != 'stopped') {
        setTimeout(challenge_player, challengeDelay)
      }
    }
    else {
      register_a_miss(currentLetter, keyCode)
    }
  }

  if (keyCode == 32) {
    e.preventDefault(); // don't let space scroll the screen down
    if (gameStatus == 'stopped') {
      start_game()
    }
  }
}


function start_game() {
  gameStatus = 'started'
  handleOverlayGameStart();

  clear_stats(nCoins)
  reset_game()
  window.game.resetChallenge(nCoins);

  setTimeout(challenge_player, challengeDelay)
}

function challenge_player() {
  var challengeTag = document.getElementById('challenge')

  currentLetter = pick_random_letter_smart()
  challengeTag.innerHTML = currentLetter
}

function clear_challenge() {
  var challengeTag = document.getElementById('challenge')
  challengeTag.innerHTML = "&nbsp;"
}

function register_a_miss(currentLetter, keyCode) {
  var tag = document.getElementById("misses")
  var missesCount =  parseInt(tag.innerHTML)
  tag.innerHTML = missesCount + 1

  game.sound.booLaugh.play();
  window.myGhost.x += 50;
}

function register_a_hit(currentLetter, keyCode) {
  var tag = document.getElementById("hits")
  var newCount =  parseInt(tag.innerHTML) + 1
  tag.innerHTML = newCount
  if (newCount >= nCoins) {
    end_game("victory")
    game.sound['victory'].play();
    window.myGhost.destroyMe = true;
  }
  window.myMario.setStance("jumping");
}

// This method picks an item from the available_letters array at random, on the fly
function pick_random_letter() {
  var max = available_letters.length - 1
  var min = 0
  var rand = Math.floor(Math.random()*(max-min+1)+min);
  return available_letters[rand]
}

// This method uses a pre-caluclated global array to source the next challenge
function pick_random_letter_smart() {
  if (window.precalculated_challenge_letters == undefined || window.precalculated_challenge_letters.length < nCoins) {
    window.precalculated_challenge_letters = shuffle(available_letters)
    window.precalculated_challenge_letters = window.precalculated_challenge_letters.concat( shuffle(available_letters) )
    window.precalculated_challenge_letters = window.precalculated_challenge_letters.concat( shuffle(available_letters) )
  }
  debugger;
  return window.precalculated_challenge_letters.splice(0,1)
}

function end_game(outcome) {
  reset_game()
  gameStatus = 'stopped'
  handleOverlayGameEnd(outcome)
  clear_challenge()
}

function reset_game() {
  clear_challenge()
}

function handleOverlayGameEnd(outcome) {
  var overlay = document.getElementById('overlay-message')
  var msg = "Great Work!"
  if (outcome != "victory")
    msg = "Game Over"

  overlay.innerHTML = msg
  setTimeout(function() {
    overlay.innerHTML = "Press Space"
  }, 5000)
  overlay.style.display = "block"
}

function handleOverlayGameStart() {
  var overlay = document.getElementById('overlay-message')
  overlay.style.display = "none"
  overlay.innerHTML = ""
}

function clear_stats(nCoins) {
  document.getElementById("hits").innerHTML = 0
  document.getElementById("misses").innerHTML = 0
  // document.getElementById("coins-left").innerHTML = nCoins
}


function toggle_about_text() {
  var about_text_tag = document.getElementById("about-text")
  global_v = about_text_tag
  if (about_text_tag.style.display == "") {
    about_text_tag.style.display = "block"
  }
  else {
    about_text_tag.style.display = ""
  }
}

// https://stackoverflow.com/questions/6274339/how-can-i-shuffle-an-array
function shuffle(array) {
  var a = array.slice(0);
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

</script>

</head>


<body onkeydown="keyboard_func(event)">

<div id="page-wrap" class="Aligner">

  <div id="console" class="Aligner-item">
    <button onclick="start_game()">Start</button>
    <button onclick="toggle_about_text()">About</button>
    <div id="about-text">
      Press the start button and a letter will appear on the screen.
      Type that letter as fast as you can to make the letter dissapear.
      The faster you are, the better your score!
      The ghost will close in on mario for as long as a letter is on the screen.
    </div>
  </div>

  <div id="game" class="Aligner-item">
    <div id="overlay-message">Press Space</div>
    <h1 id="challenge">&nbsp;</h1>
    <canvas id="canvas" width="1000" height="500"></canvas>
  </div>

  <div id="stats" class="Aligner-item">
    <!-- <div>Coins Left: <span id="coins-left"></span></div> -->
    <div>Misses: <span id="misses">0</div>
    <div>Hits: <span id="hits">0</span></div>
  </div>

  <div id="sprite-controls" class="debug">
    <div id="debug-int">0</div>
    <button onclick="spawnGhost()">Spawn Ghost</button>
    <button onclick="spawnBlah()">Spawn Blah</button>
    <button onclick="interaction()">interaction</button>
  </div>


  <audio id="audTitleScreen" class="music">
    <!-- <source src="/audio/opener/Final_Fantasy_4_Lacrima_OC_ReMix.ogg" type="audio/ogg"></source> -->
    <!-- <source src="/audio/opener/Final_Fantasy_4_Lacrima_OC_ReMix.mp3" type="audio/mp3"></source> -->
    Your browser isn't intended for super fun audio time.
  </audio>

  <audio id="audBattle" class="music">
    <!-- <source src="/audio/opener/Final_Fantasy_4_Lacrima_OC_ReMix.ogg" type="audio/ogg"></source> -->
    <!-- <source src="/audio/opener/Final_Fantasy_4_Lacrima_OC_ReMix.mp3" type="audio/mp3"></source> -->
    Your browser isn't intended for super fun audio time.
  </audio>

</div>
</body>

<!--  Load required 3rd party libraries -->

<script src="vendor/howler.min.js"></script>

<!--  Load the piffy game logic file -->


<!--  Load the more serious 2d game engine files -->

<script src="assets/effects/movable.js"></script>
<script src="assets/effects/lootable.js"></script>
<script src="assets/effects/explodable.js"></script>
<script src="assets/effects/jumpable.js"></script>

<script src="assets/enemies.json"></script>
<script src="assets/mario.json"></script>
<script src="assets/coins.json"></script>
<script src="assets/coinbox.json"></script>

<script src="engine/screen.js"></script>
<script src="engine/gameLoop.js"></script>
<script src="engine/userInput.js"></script>
<script src="unit.js"></script>
<script src="debugging.js"></script>

<script src="keyboardMemory.js"></script>
<script src="assetLoading.js"></script>
<script src="screens/coinGhostChallengeScreen/coinGhostChallengeScreen.js"></script>

<script src="animator.js"></script>

</html>
